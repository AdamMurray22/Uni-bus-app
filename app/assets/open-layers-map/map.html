<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>Map</title>

    <!-- OpenLayers v7.2.2 (https://openlayers.org/) -->
    <script src="ol/dist/ol.js"></script>
    <script src="ol/Map.js"></script>
    <script src="ol/View.js"></script>
    <script src="ol/layer/Tile.js"></script>
    <script src="ol/source/OSM.js"></script>
    <script src="ol/format/Feature.js"></script>
    <link rel="stylesheet" href="ol/ol.css">

    <script src="https://unpkg.com/elm-pep"></script>

    <!-- Ensures the map takes up the full amount of space. -->
    <link rel="stylesheet" href="map.css">
</head>

<body>
<div id="js-map" class="map"></div>
</body>

<script id="create-map">

    /*
     Map
    */

    const map = new ol.Map({
        view: new ol.View({
            center: new ol.proj.fromLonLat([1, 1]),
            zoom: 1,
        }),
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM(),
            }),
        ],
        target: 'js-map',
    });

    function setCentreZoom(value) {
        map.getView().setZoom(value.zoom);
        map.getView().setCenter(ol.proj.fromLonLat([value.long, value.lat]));
    }

</script>


<script id="markerFunctionality">

    /*
        Layers
    */

    // This layer shows the U1 bus stop markers
    var U1BusStopMarkersLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: [0.10, 0.10],
                src: "U1BusStopMarker.png",
            }),
        }),
    });
    U1BusStopMarkersLayer.isMarkerLayer = true;
    map.addLayer(U1BusStopMarkersLayer);

    // This layer shows the uni building markers
    var UniBuildingMarkersLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: [0.10, 0.10],
                src: "UniBuildingMarker.png",
            }),
        }),
    });
    UniBuildingMarkersLayer.isMarkerLayer = true;
    map.addLayer(UniBuildingMarkersLayer);

    // This layer shows the landmark markers
    var LandmarkMarkersLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: [0.10, 0.10],
                src: "LandmarkMarker.png",
            }),
        }),
    });
    LandmarkMarkersLayer.isMarkerLayer = true;
    map.addLayer(LandmarkMarkersLayer);

    // This layer shows the Users location
    const UserLocationLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: [0.10, 0.10],
                src: "UserIcon.png",
            }),
        }),
    });
    UserLocationLayer.isMarkerLayer = false;
    map.addLayer(UserLocationLayer);

    // Creates a hash map to map the given id's to the layers
    var IDLayersMap = new Map();

    // Maps the given id's to the layers
    function mapIdsToLayers(layerIds) {
        IDLayersMap.set(layerIds.U1, U1BusStopMarkersLayer);
        IDLayersMap.set(layerIds.UniBuilding, UniBuildingMarkersLayer);
        IDLayersMap.set(layerIds.Landmark, LandmarkMarkersLayer);
        IDLayersMap.set(layerIds.UserLocation, UserLocationLayer);
    }


    /*
        Detects if a marker has been clicked
    */

    map.on("click", function (e) {

        let markerFound = false;
        map.forEachFeatureAtPixel(e.pixel, function (feature, layer) {
            if (layer.isMarkerLayer && markerFound == false) {
                markerClicked(feature);
                markerFound = true;
            }
        })
    });


    /*
        Adds the markers
    */

    function addMarker(markedFeature) {
        const layer = IDLayersMap.get(markedFeature.layerId);

        const marker = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat([markedFeature.longitude, markedFeature.latitude])));
        marker.setId(markedFeature.id);
        layer.getSource().addFeature(marker);
    }

    /*
        Toggles the visibility of the markers
    */

    function toggleShowMarkers(visible) {
        const layer = IDLayersMap.get(visible.layerId);
        layer.setVisible(visible.visible);
    }

    // Removes the users icon

    function removeUserIcon(userPosition) {
        var source = UserLocationLayer.getSource();
        source.removeFeature(source.getFeatureById(userPosition.id));
    }

    // Updates the location of the users icon

    function updateUserIcon(userPosition) {
        removeUserIcon(userPosition);
        addUserIcon(userPosition);
    }

    // Marker interaction

    function markerClicked(marker) {
        MarkerClickedDart.postMessage(marker.getId());
    }

    function drawBusRouteLines(geoJson) {
        // This layer shows drawn bus route
        const defaultStyle = new ol.style.Style({
            fill: new ol.style.Fill({
                color: [0, 0, 255, 0.25],
            }),
            stroke: new ol.style.Stroke({
                color: [0, 0, 255, 0.75],
                width: 2,
            }),
        });

        const geoJsonData = new ol.source.Vector({
            features: new ol.format.GeoJSON().readFeatures(JSON.parse(geoJson.busRoute)),
            format: new ol.format.GeoJSON(),
        });

        const busRouteLayer = new ol.layer.VectorImage({
            source: geoJsonData,
            style: defaultStyle,
        });

        map.addLayer(busRouteLayer);
    }
</script>
<script id="drawingFunctionality">

    function toggleShowDrawnLines(visible) {
        busRouteLayer.setVisible(visible.visible);
    }

</script>
</html>