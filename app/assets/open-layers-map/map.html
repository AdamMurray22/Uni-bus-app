<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>Map</title>

    <!-- OpenLayers v7.2.2 (https://openlayers.org/) -->
    <script src="ol/dist/ol.js"></script>
    <link rel="stylesheet" href="ol/ol.css">

    <script src="https://unpkg.com/elm-pep"></script>

    <!-- Ensures the map takes up the full amount of space. -->
    <link rel="stylesheet" href="map.css">
</head>

<body>
<div id="map" class="map"></div>
</body>

<script id="create-map">

    /*
     Map
    */

    const map = new ol.Map({
        view: new ol.View({
            center: new ol.proj.fromLonLat([1, 1]),
            zoom: 1,
        }),
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM(),
            }),
        ],
        target: 'map',
    });

    function setCentreZoom(value) {
        map.getView().setZoom(value.zoom);
        map.getView().setCenter(ol.proj.fromLonLat([value.long, value.lat]));
    }

</script>


<script id="markerFunctionality">

    /*
        Layers
    */

    // This layer shows the U1 bus stop markers
    var U1BusStopMarkersLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: [0.10, 0.10],
                src: "U1BusStopMarker.png",
            }),
        }),
    });
    U1BusStopMarkersLayer.isMarkerLayer = true;
    map.addLayer(U1BusStopMarkersLayer);

    // This layer shows the uni building markers
    var UniBuildingMarkersLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: [0.10, 0.10],
                src: "UniBuildingMarker.png",
            }),
        }),
    });
    UniBuildingMarkersLayer.isMarkerLayer = true;
    map.addLayer(UniBuildingMarkersLayer);

    // This layer shows the landmark markers
    var LandmarkMarkersLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: [0.10, 0.10],
                src: "LandmarkMarker.png",
            }),
        }),
    });
    LandmarkMarkersLayer.isMarkerLayer = true;
    map.addLayer(LandmarkMarkersLayer);

    // This layer shows the Users location
    const UserLocationLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: [0.10, 0.10],
                src: "UserIcon.png",
            }),
        }),
    });
    UserLocationLayer.isMarkerLayer = false;
    map.addLayer(UserLocationLayer);

    // Enum to identify the type of layer
    const layerEnum = {
        markerLayer: 'markerLayer',
        geoJsonLayer: 'geoJsonLayer'
    };

    // Creates a hash map to map the given id's to the layers
    let IDLayersMap = new Map();

    // Maps the given id's to the layers
    function mapIdsToLayers(layerIds) {
        const U1Map = new Map();
        const UniBuildingMap = new Map();
        const LandmarkMap = new Map();
        const UserLocationMap = new Map();

        U1Map.set(layerEnum.markerLayer, U1BusStopMarkersLayer);
        U1Map.set(layerEnum.geoJsonLayer, busRouteLayer);
        UniBuildingMap.set(layerEnum.markerLayer, UniBuildingMarkersLayer);
        LandmarkMap.set(layerEnum.markerLayer, LandmarkMarkersLayer);
        UserLocationMap.set(layerEnum.markerLayer, UserLocationLayer);

        IDLayersMap.set(layerIds.U1, U1Map);
        IDLayersMap.set(layerIds.UniBuilding, UniBuildingMap);
        IDLayersMap.set(layerIds.Landmark, LandmarkMap);
        IDLayersMap.set(layerIds.UserLocation, UserLocationMap);
    }


    /*
        Detects if a marker has been clicked
    */

    map.on("click", function (e) {

        let markerFound = false;
        map.forEachFeatureAtPixel(e.pixel, function (feature, layer) {
            if (layer.isMarkerLayer && markerFound == false) {
                markerClicked(feature);
                markerFound = true;
            }
        })
    });


    /*
        Adds the markers
    */

    function addMarker(markedFeature) {
        const layer = IDLayersMap.get(markedFeature.layerId).get(layerEnum.markerLayer);

        const marker = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat([markedFeature.longitude, markedFeature.latitude])));
        marker.setId(markedFeature.id);
        layer.getSource().addFeature(marker);
    }

    /*
        Toggles the visibility of the markers
    */

    function toggleShowLayers(visible) {
        const layers = Array.from(IDLayersMap.get(visible.layerId).values());
        layers.forEach(function (layer) {
            layer.setVisible(visible.visible);
        })
    }

    // Removes the users icon

    function removeUserIcon(userPosition) {
        var source = UserLocationLayer.getSource();
        source.removeFeature(source.getFeatureById(userPosition.id));
    }

    // Updates the location of the users icon

    function updateUserIcon(userPosition) {
        removeUserIcon(userPosition);
        addUserIcon(userPosition);
    }

    // Marker interaction

    function markerClicked(marker) {
        MarkerClickedDart.postMessage(marker.getId());
    }
</script>
<script id="drawingFunctionality">

    // This layer shows drawn bus route
    const busRouteLayer = new ol.layer.VectorImage({
        source: new ol.source.Vector({
            format: new ol.format.GeoJSON(),
        }),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: [0, 0, 255, 0.75],
                width: 2,
            }),
        }),
    });

    map.addLayer(busRouteLayer);

    function drawBusRouteLines(geoJson) {
       // busRouteLayer.getSource().addFeature(new ol.Feature(new ol.geom.Circle([-1.0960, 50.7958], 1e6)));
        busRouteLayer.getSource().addFeatures(new ol.format.GeoJSON().readFeatures(JSON.parse(geoJson.busRoute)));
    }
</script>
</html>