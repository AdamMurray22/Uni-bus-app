import 'package:app/MapData/bus_stop.dart';
import 'package:app/MapData/bus_time.dart';
import 'package:app/Routing/RouteCreators/bus_route_geo_json_trimmer.dart';
import 'package:app/Routing/geo_json_geometry.dart';
import 'package:app/Routing/walking_route.dart';
import 'package:app/Wrapper/date_time_wrapper.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:app/Routing/location.dart';
import 'package:mockito/annotations.dart';
import 'package:mockito/mockito.dart';

import 'bus_route_geo_json_trimmer_test.mocks.dart';

@GenerateMocks([DateTimeWrapper])
void main() {
  group('Bus Route Geo Json Trimmer Tests', () {

    test('.continueBusRoute() Correct WalkingRoute generated when no final leg', () async {
      final dateTimeWrapper = MockDateTimeWrapper();

      Location from = Location(-1.0591632236028943,50.79276873036031);
      BusTime arriveBusTime = BusTime("13:32", 1);
      BusStop startBusStop = BusStop("U1-1", "Prince", -1.05857233024616, 50.7925695232834,
          {}, {BusTime("13:22", 1)}, true, 0);
      BusStop endBusStop = BusStop("U1-3", "GetOff", -1.09238477219601, 50.7953755013164,
          {}, {arriveBusTime}, true, 0);

      GeoJsonGeometry busGeoJsonGeometry = GeoJsonGeometry('{"type":"FeatureCollection","features":[{"leg":8,"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.058555710690456,50.79255324457131],[-1.0591632236028943,50.79276873036031],[-1.0600739489642876,50.79308644787176],[-1.062093473930446,50.79380509023537],[-1.0628103611903725,50.794009338696014],[-1.063580564147884,50.79418306978582],[-1.0646796983795639,50.79439539589981],[-1.0655168160320443,50.79450091516378],[-1.0666644322335515,50.79461004787848],[-1.0671126063364795,50.7947437333317],[-1.0673089127100752,50.79476121411105],[-1.0676892206602702,50.79475313368303],[-1.067992827847263,50.794706671194206],[-1.0684338571738294,50.79476323426533],[-1.069740965530741,50.79496524427853]],"type":"LineString"}},{"leg":9,"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.069740965530741,50.79496524427853],[-1.071199753137705,50.79522114172801],[-1.071637596656501,50.79530194476004],[-1.0724908926460444,50.795495872371475],[-1.07298265894471,50.79560041649333],[-1.0742737874818147,50.79588524520602],[-1.0747499105371503,50.7959983299406],[-1.0755552685491239,50.796044791145334],[-1.0760140300555179,50.79599937236395]],"type":"LineString"}},{"leg":10,"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.0760140300555179,50.79599937236395],[-1.07639258516852,50.7959599491858],[-1.0765747494807556,50.795834705605785],[-1.0766290791702318,50.79571754221894],[-1.076718563394337,50.795624619112886],[-1.0769710367398204,50.79557209727574],[-1.077172376242828,50.79553977611579],[-1.0777721093051866,50.79546893652363],[-1.0783984989984958,50.79532753113969],[-1.0788427242520982,50.79519622560116],[-1.0789513836660092,50.7951376430112],[-1.0790760224057578,50.795038658468],[-1.0791015893275073,50.79501643741949],[-1.0791525592211997,50.794858975113556],[-1.0795903927438246,50.794727668258616],[-1.079970700610886,50.79486705569113],[-1.0803893589427105,50.794980181281176],[-1.0806673983730377,50.794998361998154],[-1.0809070882576464,50.79499028161112],[-1.081402446779066,50.79497614072022],[-1.0824347112147734,50.79491755785412],[-1.0830195551123438,50.79487311590799],[-1.083626769486301,50.7948468545745]],"type":"LineString"}},{"leg":11,"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.083626769486301,50.7948468545745],[-1.0844193443698487,50.794863015772506],[-1.0854963507631226,50.79492159880354],[-1.0866467621625304,50.795010504140635],[-1.087672634405294,50.795089294455465],[-1.0880273754347627,50.79512161592689],[-1.0881824794930424,50.79514787722178],[-1.0885020660058444,50.795246861533656],[-1.088665055127251,50.79520039953567],[-1.088760931081282,50.79518625891856],[-1.0889696146099652,50.795255544175035],[-1.089158170652098,50.79524342366054],[-1.0893403347999708,50.79521918278098],[-1.0897717765916468,50.79523736356094],[-1.089918786388182,50.79525756441919],[-1.0903917745092144,50.79530200637549],[-1.0906282685288886,50.79532220720614],[-1.0912892005675303,50.79536624981347],[-1.0919603322184912,50.79542281210837],[-1.092379274573858,50.79545508221133]],"type":"LineString"}}]}');

      when(dateTimeWrapper.now()).thenAnswer((_) => DateTime(2023, 03, 15, 13, 20, 30));

      WalkingRoute testRoute = WalkingRoute([GeoJsonGeometry('{"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.0591632236028943,50.79276873036031],[-1.0591632236028943,50.79276873036031],[-1.0600739489642876,50.79308644787176],[-1.062093473930446,50.79380509023537],[-1.0628103611903725,50.794009338696014],[-1.063580564147884,50.79418306978582],[-1.0646796983795639,50.79439539589981],[-1.0655168160320443,50.79450091516378],[-1.0666644322335515,50.79461004787848],[-1.0671126063364795,50.7947437333317],[-1.0673089127100752,50.79476121411105],[-1.0676892206602702,50.79475313368303],[-1.067992827847263,50.794706671194206],[-1.0684338571738294,50.79476323426533],[-1.069740965530741,50.79496524427853],[-1.071199753137705,50.79522114172801],[-1.071637596656501,50.79530194476004],[-1.0724908926460444,50.795495872371475],[-1.07298265894471,50.79560041649333],[-1.0742737874818147,50.79588524520602],[-1.0747499105371503,50.7959983299406],[-1.0755552685491239,50.796044791145334],[-1.0760140300555179,50.79599937236395],[-1.07639258516852,50.7959599491858],[-1.0765747494807556,50.795834705605785],[-1.0766290791702318,50.79571754221894],[-1.076718563394337,50.795624619112886],[-1.0769710367398204,50.79557209727574],[-1.077172376242828,50.79553977611579],[-1.0777721093051866,50.79546893652363],[-1.0783984989984958,50.79532753113969],[-1.0788427242520982,50.79519622560116],[-1.0789513836660092,50.7951376430112],[-1.0790760224057578,50.795038658468],[-1.0791015893275073,50.79501643741949],[-1.0791525592211997,50.794858975113556],[-1.0795903927438246,50.794727668258616],[-1.079970700610886,50.79486705569113],[-1.0803893589427105,50.794980181281176],[-1.0806673983730377,50.794998361998154],[-1.0809070882576464,50.79499028161112],[-1.081402446779066,50.79497614072022],[-1.0824347112147734,50.79491755785412],[-1.0830195551123438,50.79487311590799],[-1.083626769486301,50.7948468545745],[-1.0844193443698487,50.794863015772506],[-1.0854963507631226,50.79492159880354],[-1.0866467621625304,50.795010504140635],[-1.087672634405294,50.795089294455465],[-1.0880273754347627,50.79512161592689],[-1.0881824794930424,50.79514787722178],[-1.0885020660058444,50.795246861533656],[-1.088665055127251,50.79520039953567],[-1.088760931081282,50.79518625891856],[-1.0889696146099652,50.795255544175035],[-1.089158170652098,50.79524342366054],[-1.0893403347999708,50.79521918278098],[-1.0897717765916468,50.79523736356094],[-1.089918786388182,50.79525756441919],[-1.0903917745092144,50.79530200637549],[-1.0906282685288886,50.79532220720614],[-1.0912892005675303,50.79536624981347],[-1.0919603322184912,50.79542281210837],[-1.092379274573858,50.79545508221133]],"type":"LineString"}}')],
          690, 0, null, null);

      BusRouteGeoJsonTrimmer busRouteGeoJsonTrimmer = BusRouteGeoJsonTrimmer(busGeoJsonGeometry, startBusStop, endBusStop, null, arriveBusTime, dateTimeWrapper);

      WalkingRoute route = (await busRouteGeoJsonTrimmer.continueBusRoute(from))!;

      expect(route.getGeometries(), testRoute.getGeometries());
      expect(route.getDistanceTillNextTurn(), testRoute.getDistanceTillNextTurn());
      expect(route.getNextTurn(), testRoute.getNextTurn());
      expect(route.getTotalDistance(), testRoute.getTotalDistance());
      expect(route.getTotalSeconds(), testRoute.getTotalSeconds());
    });

    test('.continueBusRoute() Correct WalkingRoute generated with final leg', () async {
      final dateTimeWrapper = MockDateTimeWrapper();

      Location from = Location(-1.0600739489642876,50.79308644787176);
      BusTime arriveBusTime = BusTime("13:32", 1);
      BusStop startBusStop = BusStop("U1-1", "Prince", -1.05857233024616, 50.7925695232834,
          {}, {BusTime("13:22", 1)}, true, 0);
      BusStop endBusStop = BusStop("U1-3", "GetOff", -1.09238477219601, 50.7953755013164,
          {}, {arriveBusTime}, true, 0);

      GeoJsonGeometry busGeoJsonGeometry = GeoJsonGeometry('{"type":"FeatureCollection","features":[{"leg":8,"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.058555710690456,50.79255324457131],[-1.0591632236028943,50.79276873036031],[-1.0600739489642876,50.79308644787176],[-1.062093473930446,50.79380509023537],[-1.0628103611903725,50.794009338696014],[-1.063580564147884,50.79418306978582],[-1.0646796983795639,50.79439539589981],[-1.0655168160320443,50.79450091516378],[-1.0666644322335515,50.79461004787848],[-1.0671126063364795,50.7947437333317],[-1.0673089127100752,50.79476121411105],[-1.0676892206602702,50.79475313368303],[-1.067992827847263,50.794706671194206],[-1.0684338571738294,50.79476323426533],[-1.069740965530741,50.79496524427853]],"type":"LineString"}},{"leg":9,"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.069740965530741,50.79496524427853],[-1.071199753137705,50.79522114172801],[-1.071637596656501,50.79530194476004],[-1.0724908926460444,50.795495872371475],[-1.07298265894471,50.79560041649333],[-1.0742737874818147,50.79588524520602],[-1.0747499105371503,50.7959983299406],[-1.0755552685491239,50.796044791145334],[-1.0760140300555179,50.79599937236395]],"type":"LineString"}},{"leg":10,"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.0760140300555179,50.79599937236395],[-1.07639258516852,50.7959599491858],[-1.0765747494807556,50.795834705605785],[-1.0766290791702318,50.79571754221894],[-1.076718563394337,50.795624619112886],[-1.0769710367398204,50.79557209727574],[-1.077172376242828,50.79553977611579],[-1.0777721093051866,50.79546893652363],[-1.0783984989984958,50.79532753113969],[-1.0788427242520982,50.79519622560116],[-1.0789513836660092,50.7951376430112],[-1.0790760224057578,50.795038658468],[-1.0791015893275073,50.79501643741949],[-1.0791525592211997,50.794858975113556],[-1.0795903927438246,50.794727668258616],[-1.079970700610886,50.79486705569113],[-1.0803893589427105,50.794980181281176],[-1.0806673983730377,50.794998361998154],[-1.0809070882576464,50.79499028161112],[-1.081402446779066,50.79497614072022],[-1.0824347112147734,50.79491755785412],[-1.0830195551123438,50.79487311590799],[-1.083626769486301,50.7948468545745]],"type":"LineString"}},{"leg":11,"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.083626769486301,50.7948468545745],[-1.0844193443698487,50.794863015772506],[-1.0854963507631226,50.79492159880354],[-1.0866467621625304,50.795010504140635],[-1.087672634405294,50.795089294455465],[-1.0880273754347627,50.79512161592689],[-1.0881824794930424,50.79514787722178],[-1.0885020660058444,50.795246861533656],[-1.088665055127251,50.79520039953567],[-1.088760931081282,50.79518625891856],[-1.0889696146099652,50.795255544175035],[-1.089158170652098,50.79524342366054],[-1.0893403347999708,50.79521918278098],[-1.0897717765916468,50.79523736356094],[-1.089918786388182,50.79525756441919],[-1.0903917745092144,50.79530200637549],[-1.0906282685288886,50.79532220720614],[-1.0912892005675303,50.79536624981347],[-1.0919603322184912,50.79542281210837],[-1.092379274573858,50.79545508221133]],"type":"LineString"}}]}');

      when(dateTimeWrapper.now()).thenAnswer((_) => DateTime(2023, 03, 15, 13, 20, 30));

      WalkingRoute finalLeg = WalkingRoute([GeoJsonGeometry('{"coordinates":[[-1.098122,50.798742],[-1.098221,50.798569],[-1.098227,50.798557],[-1.098252,50.798471],[-1.098508,50.798057],[-1.098558,50.797978],[-1.098814,50.79759],[-1.098853,50.79753],[-1.098766,50.797509],[-1.098543,50.797487],[-1.098396,50.797472],[-1.098324,50.797469],[-1.098275,50.797067],[-1.098146,50.797102],[-1.098055,50.797128],[-1.097876,50.797359],[-1.097795,50.797519],[-1.097711,50.797502],[-1.097438,50.797936],[-1.097399,50.797943],[-1.097484,50.797997],[-1.097606,50.798028],[-1.097646,50.797951]],"type":"LineString"}')],
          303.7, 379.6, 144.5, '"right"');

      WalkingRoute testRoute = WalkingRoute(
          [GeoJsonGeometry('{"type":"Feature","properties":{},"geometry":{"coordinates":[[-1.0600739489642876,50.79308644787176],[-1.0600739489642876,50.79308644787176],[-1.062093473930446,50.79380509023537],[-1.0628103611903725,50.794009338696014],[-1.063580564147884,50.79418306978582],[-1.0646796983795639,50.79439539589981],[-1.0655168160320443,50.79450091516378],[-1.0666644322335515,50.79461004787848],[-1.0671126063364795,50.7947437333317],[-1.0673089127100752,50.79476121411105],[-1.0676892206602702,50.79475313368303],[-1.067992827847263,50.794706671194206],[-1.0684338571738294,50.79476323426533],[-1.069740965530741,50.79496524427853],[-1.071199753137705,50.79522114172801],[-1.071637596656501,50.79530194476004],[-1.0724908926460444,50.795495872371475],[-1.07298265894471,50.79560041649333],[-1.0742737874818147,50.79588524520602],[-1.0747499105371503,50.7959983299406],[-1.0755552685491239,50.796044791145334],[-1.0760140300555179,50.79599937236395],[-1.07639258516852,50.7959599491858],[-1.0765747494807556,50.795834705605785],[-1.0766290791702318,50.79571754221894],[-1.076718563394337,50.795624619112886],[-1.0769710367398204,50.79557209727574],[-1.077172376242828,50.79553977611579],[-1.0777721093051866,50.79546893652363],[-1.0783984989984958,50.79532753113969],[-1.0788427242520982,50.79519622560116],[-1.0789513836660092,50.7951376430112],[-1.0790760224057578,50.795038658468],[-1.0791015893275073,50.79501643741949],[-1.0791525592211997,50.794858975113556],[-1.0795903927438246,50.794727668258616],[-1.079970700610886,50.79486705569113],[-1.0803893589427105,50.794980181281176],[-1.0806673983730377,50.794998361998154],[-1.0809070882576464,50.79499028161112],[-1.081402446779066,50.79497614072022],[-1.0824347112147734,50.79491755785412],[-1.0830195551123438,50.79487311590799],[-1.083626769486301,50.7948468545745],[-1.0844193443698487,50.794863015772506],[-1.0854963507631226,50.79492159880354],[-1.0866467621625304,50.795010504140635],[-1.087672634405294,50.795089294455465],[-1.0880273754347627,50.79512161592689],[-1.0881824794930424,50.79514787722178],[-1.0885020660058444,50.795246861533656],[-1.088665055127251,50.79520039953567],[-1.088760931081282,50.79518625891856],[-1.0889696146099652,50.795255544175035],[-1.089158170652098,50.79524342366054],[-1.0893403347999708,50.79521918278098],[-1.0897717765916468,50.79523736356094],[-1.089918786388182,50.79525756441919],[-1.0903917745092144,50.79530200637549],[-1.0906282685288886,50.79532220720614],[-1.0912892005675303,50.79536624981347],[-1.0919603322184912,50.79542281210837],[-1.092379274573858,50.79545508221133]],"type":"LineString"}}'),
            GeoJsonGeometry('{"coordinates":[[-1.092379274573858,50.79545508221133],[-1.098221,50.798569],[-1.098227,50.798557],[-1.098252,50.798471],[-1.098508,50.798057],[-1.098558,50.797978],[-1.098814,50.79759],[-1.098853,50.79753],[-1.098766,50.797509],[-1.098543,50.797487],[-1.098396,50.797472],[-1.098324,50.797469],[-1.098275,50.797067],[-1.098146,50.797102],[-1.098055,50.797128],[-1.097876,50.797359],[-1.097795,50.797519],[-1.097711,50.797502],[-1.097438,50.797936],[-1.097399,50.797943],[-1.097484,50.797997],[-1.097606,50.798028],[-1.097646,50.797951]],"type":"LineString"}')],
          690 + 303.7, 379.6, null, null);

      BusRouteGeoJsonTrimmer busRouteGeoJsonTrimmer = BusRouteGeoJsonTrimmer(busGeoJsonGeometry, startBusStop, endBusStop, finalLeg, arriveBusTime, dateTimeWrapper);

      WalkingRoute route = (await busRouteGeoJsonTrimmer.continueBusRoute(from))!;

      expect(route.getGeometries(), testRoute.getGeometries());
      expect(route.getDistanceTillNextTurn(), testRoute.getDistanceTillNextTurn());
      expect(route.getNextTurn(), testRoute.getNextTurn());
      expect(route.getTotalDistance(), testRoute.getTotalDistance());
      expect(route.getTotalSeconds(), testRoute.getTotalSeconds());
    });

    test('.atBusStop() not at bus stop', () async {
      Location from = Location(-1.0600739489642876,50.79308644787176);
      BusStop busStop1 = BusStop("U1-1", "Prince", -1.05857233024616, 50.7925695232834,
          {}, {BusTime("13:22", 1)}, true, 0);

      bool atBusStop = BusRouteGeoJsonTrimmer.atBusStop(from, busStop1);

      expect(atBusStop, false);
    });

    test('.atBusStop() at bus stop', () async {
    Location from = Location(-1.0585453160155731, 50.792524023146036);
    BusStop busStop1 = BusStop("U1-1", "Prince", -1.05857233024616, 50.7925695232834,
    {}, {BusTime("13:22", 1)}, true, 0);

    bool atBusStop = BusRouteGeoJsonTrimmer.atBusStop(from, busStop1);

    expect(atBusStop, true);
    });
  });
}